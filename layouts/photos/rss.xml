{{- /* ABOUTME: RSS feed template for photos from notes */}}
{{- /* ABOUTME: Shows images from notes with proper RSS validation */}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
{{- printf "<?xml-stylesheet href=\"/pretty-feed-v3.xsl\" type=\"text/xsl\"?>" | safeHTML }}
<rss version="2.0"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:media="http://search.yahoo.com/mrss/">
  <channel>
    <title>Snapshots taken by Harper - harper.blog</title>
    <link>{{ .Site.BaseURL }}photos/</link>
    <description>Photo posts and snapshots from {{ .Site.Title }}</description>
    <generator>Hugo -- gohugo.io</generator>
    {{ with .Site.LanguageCode }}<language>{{ . }}</language>{{ end }}
    {{ with .Site.Author.email }}<managingEditor>{{ . }}{{ with $.Site.Author.name }} ({{ . }}){{ end }}</managingEditor>{{ end }}
    {{ with .Site.Author.email }}<webMaster>{{ . }}{{ with $.Site.Author.name }} ({{ . }}){{ end }}</webMaster>{{ end }}
    {{ with .Site.Copyright }}<copyright>{{ . }}</copyright>{{ end }}
    <lastBuildDate>{{ now.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</lastBuildDate>
    {{ with .OutputFormats.Get "RSS" }}
    {{ printf "<atom:link href=%q rel=\"self\" type=%q />" .Permalink .MediaType | safeHTML }}
    {{ end }}
    <image>
      <url>{{ .Site.BaseURL }}images/favicon.png</url>
      <title>Snapshots taken by Harper - harper.blog</title>
      <link>{{ .Site.BaseURL }}photos/</link>
    </image>
    {{- /* Get notes that have image resources */ -}}
    {{ $notes := where .Site.RegularPages "Type" "notes" }}
    {{ $limit := .Site.Config.Services.RSS.Limit }}
    {{ $count := 0 }}
    {{ range $notes }}
        {{- /* Check if this note has any image resources */ -}}
        {{ $images := .Resources.ByType "image" }}
        {{ if and (gt (len $images) 0) (lt $count $limit) }}
        {{ $count = add $count 1 }}
        {{ $imageCount := len $images }}
        <item>
        <title>{{ with .Title }}{{ . }}{{ else }}Photo Post{{ end }}</title>
        <link>{{ .Permalink }}</link>
        <pubDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
        {{ with $.Site.Author.email }}<author>{{ . }}{{ with $.Site.Author.name }} ({{ . }}){{ end }}</author>{{ end }}
        <guid>{{ .Permalink }}</guid>
        {{- /* First image as primary enclosure with required length attribute */ -}}
        {{ $firstImage := index $images 0 }}
        {{ with $firstImage }}
        <enclosure url="{{ .Permalink }}" type="{{ .MediaType }}" length="0" />
        {{ end }}
        {{- /* Media content - only use group when multiple images */ -}}
        {{ if gt $imageCount 1 }}
        <media:group>
        {{ range $idx, $img := $images }}
          <media:content url="{{ $img.Permalink }}" medium="image" type="{{ $img.MediaType }}"{{ with $img.Width }} width="{{ . }}"{{ end }}{{ with $img.Height }} height="{{ . }}"{{ end }} />
        {{ end }}
        </media:group>
        {{ else }}
        {{ with $firstImage }}
        <media:content url="{{ .Permalink }}" medium="image" type="{{ .MediaType }}"{{ with .Width }} width="{{ . }}"{{ end }}{{ with .Height }} height="{{ . }}"{{ end }} />
        {{ end }}
        {{ end }}
        {{- /* Thumbnail from first image */ -}}
        {{ with $firstImage }}
        <media:thumbnail url="{{ .Permalink }}" />
        {{ end }}
        <category>Photos</category>
        <description>{{ printf "<![CDATA[" | safeHTML }}
            <div>
            {{- /* Photo count badge */ -}}
            <p>
              <strong>{{ $imageCount }} photo{{ if gt $imageCount 1 }}s{{ end }}</strong>
              - {{ .Date.Format "January 2, 2006" }}
            </p>

            {{- /* Caption/Content first if exists */ -}}
            {{ with .Content }}
            <div>
              {{ . | html }}
            </div>
            {{ end }}

            {{- /* Photo gallery - show ALL images */ -}}
            {{ range $images }}
            <p>
              <a href="{{ $.Permalink }}">
                <img src="{{ .Permalink }}" alt="Photo" style="max-width:100%;height:auto;" />
              </a>
            </p>
            {{ end }}

            {{- /* View all link */ -}}
            <p>
              <a href="{{ .Permalink }}">View Full Post</a>
            </p>

            </div>
            <img src="https://tinylytics.app/pixel/WV5Khk7ZG6MZe6q49ikx.gif" alt="" width="1" height="1" />
        {{ printf "]]>" | safeHTML }}</description>
        </item>
        {{ end }}
    {{ end }}
  </channel>
</rss>
