{{- /* ABOUTME: Rich RSS feed template for music/Spotify tracks */}}
{{- /* ABOUTME: Includes album art, Spotify embeds, duration, and preview links */}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
{{- printf "<?xml-stylesheet href=\"/pretty-feed-v3.xsl\" type=\"text/xsl\"?>" | safeHTML }}
<rss version="2.0"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:media="http://search.yahoo.com/mrss/"
     xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"
     xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>{{ if eq .Title .Site.Title }}{{ .Site.Title }}{{ else }}{{ with .Title }}{{ . }} on {{ end }}{{ .Site.Title }}{{ end }}</title>
    <link>{{ .Permalink }}</link>
    <description>Recent Music{{ if ne .Title .Site.Title }} on {{ .Site.Title }}{{ end }}</description>
    <generator>Hugo -- gohugo.io</generator>
    {{ with .Site.LanguageCode }}<language>{{ . }}</language>{{ end }}
    {{ with .Site.Author.email }}<managingEditor>{{ . }}{{ with $.Site.Author.name }} ({{ . }}){{ end }}</managingEditor>{{ end }}
    {{ with .Site.Author.email }}<webMaster>{{ . }}{{ with $.Site.Author.name }} ({{ . }}){{ end }}</webMaster>{{ end }}
    {{ with .Site.Copyright }}<copyright>{{ . }}</copyright>{{ end }}
    {{ if not .Date.IsZero }}<lastBuildDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</lastBuildDate>{{ end }}
    {{ with .OutputFormats.Get "RSS" }}
    {{ printf "<atom:link href=%q rel=\"self\" type=%q />" .Permalink .MediaType | safeHTML }}
    {{ end }}
    <image>
      <url>{{ .Site.BaseURL }}images/favicon.png</url>
      <title>{{ .Site.Title }} - Music</title>
      <link>{{ .Permalink }}</link>
    </image>
    {{ $limit := .Site.Config.Services.RSS.Limit }}
    {{ $pages := .Pages }}
    {{ if gt $limit 0 }}{{ $pages = $pages | first $limit }}{{ end }}
    {{ range $pages }}
        <item>
        <title>{{ .Title }}{{ with .Params.artist }} - {{ . }}{{ end }}</title>
        {{ with .Params.spotify_url }}
        <link>{{ . }}</link>
        {{ else }}
        <link>{{ .Permalink }}</link>
        {{ end }}
        <pubDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
        {{ with .Site.Author.email }}<author>{{ . }}{{ with $.Site.Author.name }} ({{ . }}){{ end }}</author>{{ end }}
        <guid>{{ .Permalink }}</guid>
        {{- /* Artist metadata */ -}}
        {{ with .Params.artist }}<itunes:author>{{ . }}</itunes:author>{{ end }}
        {{- /* Duration in seconds for podcast clients */ -}}
        {{ with .Params.duration }}
        {{ $seconds := div . 1000 }}
        <itunes:duration>{{ $seconds }}</itunes:duration>
        {{ end }}
        {{- /* Album art as media */ -}}
        {{ with .Params.album_image }}
        <enclosure url="{{ . }}" type="image/jpeg" />
        <media:content url="{{ . }}" medium="image" type="image/jpeg">
          <media:title>{{ $.Params.album }} album art</media:title>
        </media:content>
        <media:thumbnail url="{{ . }}" width="300" height="300" />
        <itunes:image href="{{ . }}" />
        {{ end }}
        {{- /* Preview audio if available */ -}}
        {{ with .Params.preview_url }}
        <media:content url="{{ . }}" medium="audio" type="audio/mpeg">
          <media:title>{{ $.Title }} preview</media:title>
        </media:content>
        {{ end }}
        {{- /* Categories */ -}}
        <category>Music</category>
        {{ with .Params.artist }}<category>{{ . }}</category>{{ end }}
        <content:encoded><![CDATA[
            <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start;">
            {{- /* Large album art */ -}}
            {{ with .Params.album_image }}
            <div style="flex:0 0 250px;">
              <img src="{{ . }}" alt="{{ $.Params.album }} album art" style="width:250px;height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);"/>
            </div>
            {{ end }}
            <div style="flex:1;min-width:250px;">
              <h2 style="margin:0 0 5px 0;">üéµ {{ .Title }}</h2>
              {{ with .Params.artist }}<p style="font-size:1.2em;margin:0 0 10px 0;"><strong>{{ . }}</strong></p>{{ end }}
              {{ with .Params.album }}<p style="color:#666;margin:0 0 15px 0;">from <em>{{ . }}</em></p>{{ end }}

              {{- /* Duration */ -}}
              {{ with .Params.duration }}
              {{ $totalSeconds := div . 1000 }}
              {{ $minutes := div $totalSeconds 60 }}
              {{ $seconds := mod $totalSeconds 60 }}
              <p style="margin:10px 0;">
                <span style="display:inline-block;padding:4px 12px;background:#1DB954;color:#fff;border-radius:20px;font-size:0.9em;">
                  ‚è±Ô∏è {{ $minutes }}:{{ printf "%02d" $seconds }}
                </span>
              </p>
              {{ end }}

              {{- /* Spotify embed */ -}}
              {{ with .Params.spotify_url }}
              {{ $trackId := replaceRE ".*track/" "" . }}
              <div style="margin:15px 0;">
                <iframe
                  src="https://open.spotify.com/embed/track/{{ $trackId }}?utm_source=generator&theme=0"
                  width="100%"
                  height="152"
                  frameBorder="0"
                  allowfullscreen=""
                  allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                  loading="lazy"
                  style="border-radius:12px;max-width:400px;">
                </iframe>
              </div>
              {{ end }}

              {{- /* Action buttons */ -}}
              <div style="margin:15px 0;">
                {{ with .Params.spotify_url }}
                <a href="{{ . }}" style="display:inline-block;padding:10px 20px;background:#1DB954;color:#fff;text-decoration:none;border-radius:25px;font-weight:bold;">
                  <span style="vertical-align:middle;">‚ñ∂Ô∏è Play on Spotify</span>
                </a>
                {{ end }}
                {{ with .Params.preview_url }}
                <audio controls style="display:block;margin-top:10px;max-width:300px;">
                  <source src="{{ . }}" type="audio/mpeg">
                  Your browser does not support audio.
                </audio>
                <p style="font-size:0.8em;color:#888;margin:5px 0;">30-second preview</p>
                {{ end }}
              </div>

              <p style="font-size:0.9em;color:#888;margin-top:15px;">
                Added {{ .Date.Format "January 2, 2006" }}
              </p>
            </div>
            </div>

            <hr style="margin:20px 0;border:none;border-top:1px solid #eee;"/>
            <p><a href="{{ .Permalink }}">View on {{ $.Site.Title }}</a></p>
            <img src="https://tinylytics.app/pixel/WV5Khk7ZG6MZe6q49ikx.gif" alt="" width="1" height="1" />
        ]]></content:encoded>
        </item>
    {{ end }}
  </channel>
</rss>
