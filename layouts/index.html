{{- define "main" }}

{{- $posts := where .Site.RegularPages "Section" "in" .Site.Params.mainSections }}
{{ $posts }}

{{ $sortedPosts := sort $posts "Date"}}

{{ $photos := where .Site.RegularPages "Section" "photos" }}
{{ $books := where .Site.RegularPages "Section" "books" }}
<br>
Total Books: {{$books}}
Total Photos: {{$photos}}
<br>
{{ if gt (len $posts) 0 }}
{{ $firstPost := index $posts 0 }}
{{ $photosBeforeFirstPost := where $photos "Date" "lt" $firstPost.Date }}
{{ $booksBeforeFirstPost := where $books "Date" "lt" $firstPost.Date }}

<div>
    <h2>Before the first post</h2>
    {{ if gt (len $photosBeforeFirstPost) 0 }}
    <p>Photos taken before the first post:</p>
    <ul>
        {{ range $photosBeforeFirstPost }}
        <li>{{ .Title }}</li>
        {{ end }}
    </ul>
    {{ else }}
    <p>No photos taken before the first post.</p>
    {{ end }}
    {{ if gt (len $booksBeforeFirstPost) 0 }}
    <p>Books read before the first post:</p>
    <ul>
        {{ range $booksBeforeFirstPost }}
        <li>{{ .Title }}</li>
        {{ end }}
    </ul>
    {{ else }}
    <p>No books read before the first post.</p>
    {{ end }}
</div>
{{ end }}

{{ range $index, $post := $posts}}
{{ if gt $index 0 }}
{{ $prevPost := index $posts (sub $index 1) }}
{{ $photosInRange := where $photos "Date" "lt" $prevPost.Date }}
{{ $photosInRange := where $photosInRange "Date" "ge" $post.Date }}

{{ $booksInRange := where $books "Date" "lt" $prevPost.Date }}
{{ $booksInRange := where $booksInRange "Date" "gt" $post.Date }}

<div>
    <h2>{{ $post.Title }}</h2>
    <p>{{ dateFormat "January 2, 2006" $post.Date }}</p>
    {{ if gt (len $photosInRange) 0 }}
    <p>Photos taken since last post:</p>
    <ul>
        {{ range $photosInRange }}
        <li>{{ .Title }}</li>
        {{ end }}
    </ul>
    {{ else }}
    <p>No new photos since last post.</p>
    {{ end }}
    {{ if gt (len $booksInRange) 0 }}
    <p>Books read since last post:</p>
    <ul>
        {{ range $booksInRange }}
        <li>{{ .Title }}</li>
        {{ end }}
    </ul>
    {{ else }}
    <p>No books read since last post.</p>
    {{ end }}
</div>
{{ end }} {{ end }} {{- end }}
